package org.egov.inv.domain.service;import org.egov.common.DomainService;import org.egov.common.MdmsRepository;import org.egov.common.Pagination;import org.egov.common.exception.CustomBindException;import org.egov.common.exception.ErrorCode;import org.egov.common.exception.InvalidDataException;import org.egov.inv.model.*;import org.egov.inv.persistence.entity.MaterialStoreMappingEntity;import org.egov.inv.persistence.repository.MaterialStoreMappingJdbcRepository;import org.egov.tracer.model.CustomException;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.beans.factory.annotation.Value;import org.springframework.stereotype.Service;import java.util.ArrayList;import java.util.Arrays;import java.util.List;import java.util.stream.Collectors;import static org.springframework.util.StringUtils.isEmpty;@Servicepublic class MaterialStoreMappingService extends DomainService {    public static final String INV_001 = "inv.001";    public static final String STORE = "store";    public static final String MATERIAL = "material";    public static final String INV_005 = "inv.005";    @Autowired    private MaterialStoreMappingJdbcRepository materialStoreMappingJdbcRepository;    @Autowired    private StoreService storeService;    @Value("${inv.materialstore.save.topic}")    private String saveTopic;    @Value("${inv.materialstore.save.key}")    private String saveKey;    @Value("${inv.materialstore.update.topic}")    private String updateTopic;    @Value("${inv.materialstore.update.key}")    private String updateKey;    @Value("${inv.materialstore.delete.topic}")    private String deleteTopic;    @Value("${inv.materialstore.delete.key}")    private String deletekey;    @Value("${es.enabled}")    private boolean isESEnabled;    @Value("${financial.enabled}")    private boolean isFinancialEnabled;    @Autowired    private MdmsRepository mdmsRepository;    public MaterialStoreMappingResponse create(MaterialStoreMappingRequest materialStoreMappingRequest, String tenantId) {        try {            List<MaterialStoreMapping> materialStoreMappings = materialStoreMappingRequest.getMaterialStoreMappings();            List<String> sequenceNos = materialStoreMappingJdbcRepository.getSequence(MaterialStoreMapping.class.getSimpleName(), materialStoreMappings.size());            int i = 0;            for (MaterialStoreMapping materialStoreMapping : materialStoreMappings) {                materialStoreMapping.setId(sequenceNos.get(i));                materialStoreMapping.setAuditDetails(mapAuditDetails(materialStoreMappingRequest.getRequestInfo()));                if (isEmpty(materialStoreMapping.getTenantId())){                    materialStoreMapping.setTenantId(tenantId);                }                validateCreateRequest(materialStoreMapping, tenantId);                i++;            }            kafkaQue.send(saveTopic, saveKey, materialStoreMappingRequest);            MaterialStoreMappingResponse materialStoreMappingResponse = new MaterialStoreMappingResponse();            materialStoreMappingResponse.setMaterialStoreMappings(materialStoreMappings);            materialStoreMappingResponse.setResponseInfo(getResponseInfo(materialStoreMappingRequest.getRequestInfo()));            return materialStoreMappingResponse;        } catch (CustomBindException e) {            throw e;        }    }    public MaterialStoreMappingResponse update(MaterialStoreMappingRequest materialStoreMappingRequest, String tenantId) {        try {           /* List<MaterialStoreMapping> deleteStoreMappings = materialStoreMappingRequest.getMaterialStoreMappings().stream()                    .filter(materialStoreMapping ->                            null != materialStoreMapping.getDelete() && materialStoreMapping.getDelete().equals(Boolean.TRUE))                    .collect(Collectors.toList());            if (deleteStoreMappings.size() > 0) {                deleteMaterialStore(materialStoreMappingRequest.getRequestInfo(), deleteStoreMappings, tenantId);                materialStoreMappingRequest.getMaterialStoreMappings().remove(deleteStoreMappings);            }*/            materialStoreMappingRequest.getMaterialStoreMappings().stream()                    .forEach(materialStoreMapping -> {                        materialStoreMapping.setAuditDetails(mapAuditDetails(materialStoreMappingRequest.getRequestInfo()));                        if (isEmpty(materialStoreMapping.getTenantId())){                            materialStoreMapping.setTenantId(tenantId);                        }                        validateUpdateRequest(materialStoreMapping, tenantId);                        buildMaterialStoreMapping(tenantId, materialStoreMapping);                    });            kafkaQue.send(updateTopic, updateKey, materialStoreMappingRequest);            MaterialStoreMappingResponse response = new MaterialStoreMappingResponse();            response.setResponseInfo(getResponseInfo(materialStoreMappingRequest.getRequestInfo()));            response.setMaterialStoreMappings(materialStoreMappingRequest.getMaterialStoreMappings());            return response;        } catch (CustomBindException e) {            throw e;        }    }    private void deleteMaterialStore(RequestInfo requestInfo, List<MaterialStoreMapping> materialStoreMappings, String tenantId) {        MaterialStoreMappingRequest storeMappingRequest = MaterialStoreMappingRequest.builder()                .requestInfo(requestInfo)                .materialStoreMappings(materialStoreMappings)                .build();        kafkaQue.send(deleteTopic, deletekey, storeMappingRequest);    }    public MaterialStoreMappingResponse search(MaterialStoreMappingSearch materialStoreMappingSearch, org.egov.common.contract.request.RequestInfo requestInfo) {        Pagination<MaterialStoreMapping> materialStoreMappingList = materialStoreMappingJdbcRepository.search(materialStoreMappingSearch);        materialStoreMappingList.getPagedData().stream()                .forEach(materialStoreMapping ->                        buildMaterialStoreMapping(materialStoreMappingSearch.getTenantId(), materialStoreMapping));        MaterialStoreMappingResponse response = new MaterialStoreMappingResponse();        response.setMaterialStoreMappings(materialStoreMappingList.getPagedData());        return response;    }    private void validateUpdateRequest(MaterialStoreMapping materialStoreMapping, String tenantId) {        InvalidDataException errors = new InvalidDataException();        setTenantNotPresent(materialStoreMapping, tenantId);        validateChartOfAccount(materialStoreMapping, errors);        if (null != materialStoreMapping.getMaterial() && !isEmpty(materialStoreMapping.getMaterial().getCode())) {            validateMaterial(materialStoreMapping, tenantId, errors);        }        uniqueCheck(materialStoreMapping, errors);        if (errors.getValidationErrors().size() > 0) {            throw errors;        }    }    private void setTenantNotPresent(MaterialStoreMapping materialStoreMapping, String tenantId) {        if (isEmpty(materialStoreMapping.getTenantId())) {            materialStoreMapping.setTenantId(tenantId);        }    }    private MaterialStoreMappingRequest buildCreateRequest(MaterialStoreMapping materialStoreMapping, RequestInfo requestInfo) {        List<MaterialStoreMapping> materialStoreMappings = new ArrayList<>();        materialStoreMappings.add(materialStoreMapping);        return MaterialStoreMappingRequest.builder()                .requestInfo(requestInfo)                .materialStoreMappings(materialStoreMappings)                .build();    }    private void validateCreateRequest(MaterialStoreMapping materialStoreMapping, String tenantId) {        InvalidDataException errors = new InvalidDataException();        setTenantNotPresent(materialStoreMapping, tenantId);        validateChartOfAccount(materialStoreMapping, errors);        getStore(materialStoreMapping.getStore().getCode(), materialStoreMapping.getTenantId());        uniqueCheck(materialStoreMapping, errors);        if (null != materialStoreMapping.getMaterial() && !isEmpty(materialStoreMapping.getMaterial().getCode())) {            validateMaterial(materialStoreMapping, tenantId, errors);        }        if (errors.getValidationErrors().size() > 0) {            throw errors;        }    }    private void validateMaterial(MaterialStoreMapping materialStoreMapping, String tenantId, InvalidDataException errors) {        Material material = (Material) mdmsRepository.fetchObject(tenantId, "inventory", "Material", "code", materialStoreMapping.getMaterial().getCode(), Material.class);        if (null == material) {            errors.addDataError(ErrorCode.OBJECT_NOT_FOUND.getCode(), "Material", materialStoreMapping.getMaterial().getCode());        }    }    private void validateChartOfAccount(MaterialStoreMapping materialStoreMapping, InvalidDataException errors) {        if (isFinancialEnabled && isEmpty(materialStoreMapping.getChartofAccount().getGlCode())) {            errors.addDataError(ErrorCode.NULL_VALUE.getCode(), "Account Code");        }    }    private List<MaterialStoreMapping> findMaterialStore(String tenantId, MaterialStoreMapping materialStoreMapping) {        MaterialStoreMappingSearch materialStoreMappingSearch = new MaterialStoreMappingSearch();        materialStoreMappingSearch.setMaterial(materialStoreMapping.getMaterial().getCode());        materialStoreMappingSearch.setStore(materialStoreMapping.getStore().getCode());        materialStoreMappingSearch.setTenantId(tenantId);        return materialStoreMappingJdbcRepository.search(materialStoreMappingSearch).getPagedData();    }    private void buildMaterialStoreMapping(String tenantId, MaterialStoreMapping materialStoreMapping) {        Store store = getStore(materialStoreMapping.getStore().getCode(), tenantId);        materialStoreMapping.setStore(store);    }    private Store getStore(String storeCode, String tenantId) {        StoreGetRequest storeGetRequest = getStoreGetRequest(storeCode, tenantId);        List<Store> storeList = storeService.search(storeGetRequest).getStores();        if (null != storeList && storeList.size() > 0) {            return storeList.get(0);        } else {            throw new CustomException(INV_005, "Store Not Found " + storeCode);        }    }    private void uniqueCheck(MaterialStoreMapping materialStoreMapping, InvalidDataException errors) {        if (!materialStoreMappingJdbcRepository.uniqueCheck(MATERIAL, STORE, new MaterialStoreMappingEntity().toEntity(materialStoreMapping))) {            errors.addDataError(ErrorCode.COMBINATION_EXISTS.getCode(), "Material", materialStoreMapping.getMaterial().getCode(), "store", materialStoreMapping.getStore().getCode());        }    }    private StoreGetRequest getStoreGetRequest(String storeCode, String tenantId) {        return StoreGetRequest.builder()                .code(Arrays.asList(storeCode))                .tenantId(tenantId)                .build();    }}